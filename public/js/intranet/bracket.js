!function(n){function e(n){return!isNaN(parseFloat(n))&&isFinite(n)}function t(n){function e(n,t){return n instanceof Array?e(n[0],t+1):t}return e(n,0)}function i(n,e){return e>0&&(n=i([n],e-1)),n}function r(){return{source:null,name:null,id:-1,idx:-1,score:null}}function a(n){if(e(n.a.score)&&e(n.b.score)){if(n.a.score>n.b.score)return[n.a,n.b];if(n.a.score<n.b.score)return[n.b,n.a]}return[]}function s(n){return a(n)[0]||r()}function o(n){return a(n)[1]||r()}function c(e,t,i){var r,a=i.find(".team[data-teamid="+e+"]");return r=t?t:"highlight",{highlight:function(){a.each(function(){n(this).addClass(r),n(this).hasClass("win")&&n(this).parent().find(".connector").addClass(r)})},deHighlight:function(){a.each(function(){n(this).removeClass(r),n(this).parent().find(".connector").removeClass(r)})}}}function l(e,t,i){var r=i||t,a=r.winner(),s=r.loser(),o=null,l=null;a&&s&&(o=c(a.idx,"highlightWinner",e),l=c(s.idx,"highlightLoser",e),o.highlight(),l.highlight()),e.find(".team").mouseover(function(){var t=n(this).attr("data-teamid"),i=c(t,null,e);i.highlight(),n(this).mouseout(function(){i.deHighlight(),n(this).unbind("mouseout")})})}function u(e,t,i){var r=n('<input type="text">');r.val(t),e.html(r),r.focus(),r.blur(function(){i(r.val())}),r.keydown(function(n){var e=n.keyCode||n.which;(9===e||13===e||27===e)&&(n.preventDefault(),i(r.val(),27!==e))})}function h(n,e){n.append(e)}function d(n){var e=n.el,t=e.find(".team.win");t.append('<div class="bubble">1st</div>');var i=e.find(".team.lose");return i.append('<div class="bubble">2nd</div>'),!0}function f(n){var e=n.el,t=e.find(".team.win");t.append('<div class="bubble third">3rd</div>');var i=e.find(".team.lose");return i.append('<div class="bubble fourth">4th</div>'),!0}function v(n,e,t,i){for(var r,a=Math.log(2*e.length)/Math.log(2),s=e.length,o=0;a>o;o+=1){r=n.addRound();for(var c=0;s>c;c+=1){var l=null;if(0===o&&(l=function(){var n=e[c],t=c;return[{source:function(){return{name:n[0],idx:2*t}}},{source:function(){return{name:n[1],idx:2*t+1}}}]}),o===a-1&&t){var u=r.addMatch(l,d);u.setAlignCb(function(n){n.css("top",""),n.css("position","absolute"),i?n.css("top",u.el.height()/2-n.height()/2+"px"):n.css("bottom",-n.height()/2+"px")})}else r.addMatch(l)}s/=2}if(t&&(n["final"]().connectorCb(function(){return null}),e.length>1&&!i)){var h=n["final"]().round().prev().match(0).loser,v=n["final"]().round().prev().match(1).loser,p=r.addMatch(function(){return[{source:h},{source:v}]},f);p.setAlignCb(function(e){var t=n.el.height()/2;p.el.css("height",t+"px");var i=e.height();e.css("top",i+"px")}),p.connectorCb(function(){return null})}}function p(n,e,t){for(var i=Math.log(2*t)/Math.log(2)-1,r=t/2,a=0;i>a;a+=1){for(var s=0;2>s;s+=1)for(var o=e.addRound(),c=0;r>c;c+=1){var l=null;(s%2!==0||0===a)&&(l=function(){if(s%2===0&&0===a)return[{source:n.round(0).match(2*c).loser},{source:n.round(0).match(2*c+1).loser}];var t=c;return a%2===0&&(t=r-c-1),[{source:e.round(2*a).match(c).winner},{source:n.round(a+1).match(t).loser}]});var u=o.addMatch(l),h=u.el.find(".teamContainer");if(u.setAlignCb(function(){h.css("top",u.el.height()/2-h.height()/2+"px")}),i-1>a||1>s){var d=null;s%2===0&&(d=function(n,e){var t=n.height()/4,i=0,r=0;return 0===e.winner().id?r=t:1===e.winner().id?(i=2*-t,r=t):r=2*t,{height:i,shift:r}}),u.connectorCb(d)}}r/=2}}function g(n,e,t,i,r,a){var s=n.addRound(),o=s.addMatch(function(){return[{source:e.winner},{source:t.winner}]},function(r){var s=!1;if(i||null===r.winner().name||r.winner().name!==t.winner().name)return d(r);if(2!==n.size()){var o=n.addRound(function(){var e=null!==r.winner().name&&r.winner().name===t.winner().name;return s===!1&&e&&(s=!0,a.css("width",parseInt(a.css("width"),10)+140+"px")),!e&&s&&(s=!1,n.dropRound(),a.css("width",parseInt(a.css("width"),10)-140+"px")),e}),c=o.addMatch(function(){return[{source:r.first},{source:r.second}]},d);return r.connectorCb(function(n){return{height:0,shift:n.height()/2}}),c.connectorCb(function(){return null}),c.setAlignCb(function(n){var i=e.el.height()+t.el.height();c.el.css("height",i+"px");var r=(e.el.height()/2+e.el.height()+t.el.height()/2)/2-n.height();n.css("top",r+"px")}),!1}});o.setAlignCb(function(n){var i=e.el.height()+t.el.height();r||(i/=2),o.el.css("height",i+"px");var a=(e.el.height()/2+e.el.height()+t.el.height()/2)/2-n.height();n.css("top",a+"px")});var c,l;if(!r){var u=t["final"]().round().prev().match(0).loser,h=s.addMatch(function(){return[{source:u},{source:t.loser}]},f);h.setAlignCb(function(n){var i=(e.el.height()+t.el.height())/2;h.el.css("height",i+"px");var r=(e.el.height()/2+e.el.height()+t.el.height()/2)/2+n.height()/2-i;n.css("top",r+"px")}),o.connectorCb(function(){return null}),h.connectorCb(function(){return null})}e["final"]().connectorCb(function(n){var i=n.height()/4,r=(e.el.height()/2+e.el.height()+t.el.height()/2)/2-n.height()/2,a=r-e.el.height()/2;return 0===e.winner().id?(l=a+2*i,c=i):1===e.winner().id?(l=a,c=3*i):(l=a+i,c=2*i),l-=n.height()/2,{height:l,shift:c}}),t["final"]().connectorCb(function(n){var i=n.height()/4,r=(e.el.height()/2+e.el.height()+t.el.height()/2)/2-n.height()/2,a=r-e.el.height()/2;return 0===t.winner().id?(l=a,c=3*i):1===t.winner().id?(l=a+2*i,c=i):(l=a+i,c=2*i),l+=n.height()/2,{height:-l,shift:-c}})}function m(e,t,i,r,a,s){var o=[],c=n('<div class="round"></div>');return{el:c,bracket:e,id:i,addMatch:function(n,t){var a,c=o.length;a=null!==n?n():[{source:e.round(i-1).match(2*c).winner},{source:e.round(i-1).match(2*c+1).winner}];var l=s(this,a,c,r?r[c]:null,t);return o.push(l),l},match:function(n){return o[n]},prev:function(){return t},size:function(){return o.length},render:function(){c.empty(),("function"!=typeof a||a())&&(c.appendTo(e.el),n.each(o,function(n,e){e.render()}))},results:function(){var e=[];return n.each(o,function(n,t){e.push(t.results())}),e}}}function b(e,t,i){var r=[];return{el:e,addRound:function(n){var e=r.length,a=null;e>0&&(a=r[e-1]);var s=m(this,a,e,t?t[e]:null,n,i);return r.push(s),s},dropRound:function(){r.pop()},round:function(n){return r[n]},size:function(){return r.length},"final":function(){return r[r.length-1].match(0)},winner:function(){return r[r.length-1].match(0).winner()},loser:function(){return r[r.length-1].match(0).loser()},render:function(){e.empty();for(var n=0;n<r.length;n+=1)r[n].render()},results:function(){var e=[];return n.each(r,function(n,t){e.push(t.results())}),e}}}function w(e,t,i,r){var a=parseInt(n(".round:first").css("margin-right"),10)/2,s=!0;0>e&&(s=!1,e=-e),2>e&&(e=0);var o=n('<div class="connector"></div>').appendTo(i);o.css("height",e),o.css("width",a+"px"),o.css(r,-a-2+"px"),t>=0?o.css("top",t+"px"):o.css("bottom",-t+"px"),s?o.css("border-bottom","none"):o.css("border-top","none");var c=n('<div class="connector"></div>').appendTo(o);return c.css("width",a+"px"),c.css(r,-a+"px"),s?c.css("bottom","0px"):c.css("top","0px"),o}function C(e,t,i){if(i.disableEditButtons)return!1;var r=n('<div class="tools"></div>').appendTo(e),a=n('<span class="increment">+</span>').appendTo(r);if(a.click(function(){var n,e=t.teams.length;for(n=0;e>n;n+=1)t.teams.push(["",""]);return k(i)}),t.teams.length>1&&1===t.results.length||t.teams.length>2&&3===t.results.length){var s=n('<span class="decrement">-</span>').appendTo(r);s.click(function(){return t.teams.length>1?(t.teams=t.teams.slice(0,t.teams.length/2),k(i)):void 0})}var o;1===t.results.length&&t.teams.length>1?(o=n('<span class="doubleElimination">de</span>').appendTo(r),o.click(function(){return t.teams.length>1&&t.results.length<3?(t.results.push([],[]),k(i)):void 0})):3===t.results.length&&t.teams.length>1&&(o=n('<span class="singleElimination">se</span>').appendTo(r),o.click(function(){return 3===t.results.length?(t.results=t.results.slice(0,1),k(i)):void 0}))}var k=function(r){function a(n){d=0,k.render(),x&&y&&(x.render(),y.render()),l(M,k,y),n&&(m.results[0]=k.results(),x&&y&&(m.results[1]=x.results(),m.results[2]=y.results()),r.save&&r.save(m,r.userData))}function c(t,i,c,l,u){function h(t,i,c){var l,u=d,h=n('<div class="score" data-resultid="result-'+u+'"></div>');l=i.name&&c&&e(i.score)?i.score:"--",h.append(l),d+=1;var f=i.name?i.name:"--",p=n('<div class="team"></div>'),g=n('<div class="label"></div>').appendTo(p);return 0===t&&p.attr("data-resultid","team-"+u),r.decorator.render(g,f,l),e(i.idx)&&p.attr("data-teamid",i.idx),null===i.name?p.addClass("na"):s(v).name===i.name?p.addClass("win"):o(v).name===i.name&&p.addClass("lose"),p.append(h),null!==i.name&&c&&r.save&&r.save&&(r.disableTeamNameEdit||(g.addClass("editable"),g.click(function(){function e(){function o(o,c){o&&(r.init.teams[~~(i.idx/2)][i.idx%2]=o),a(!0),s.click(e);var l=r.el.find(".team[data-teamid="+(i.idx+1)+"] div.label:first");l.length&&c===!0&&0===t&&n(l).click()}s.unbind(),r.decorator.edit(s,i.name,o)}var s=n(this);e()})),i.name&&(h.addClass("editable"),h.click(function(){function t(){r.unbind();var s;s=e(i.score)?r.text():"0";var o=n('<input type="text">');o.val(s),r.html(o),o.focus().select(),o.keydown(function(t){e(n(this).val())?n(this).removeClass("error"):n(this).addClass("error");var i=t.keyCode||t.which;if(9===i||13===i||27===i){if(t.preventDefault(),n(this).blur(),27===i)return;var r=M.find("div.score[data-resultid=result-"+(u+1)+"]");r&&r.click()}}),o.blur(function(){var n=o.val();n&&e(n)||e(i.score)?n&&e(n)||!e(i.score)||(n=i.score):n="0",r.html(n),e(n)&&s!==parseInt(n,10)&&(i.score=parseInt(n,10),a(!0)),r.click(t)})}var r=n(this);t()}))),p}var v={a:i[0],b:i[1]},p=null,g=null,m=n('<div class="match"></div>'),b=n('<div class="teamContainer"></div>');if(!r.save){var C=l?l[2]:null;r.onMatchHover&&b.hover(function(){r.onMatchHover(C,!0)},function(){r.onMatchHover(C,!1)}),r.onMatchClick&&b.click(function(){r.onMatchClick(C)})}return v.a.id=0,v.b.id=1,v.a.name=v.a.source().name,v.b.name=v.b.source().name,v.a.score=l?l[0]:null,v.b.score=l?l[1]:null,v.a.name&&v.b.name||!e(v.a.score)&&!e(v.b.score)||(console.log("ERROR IN SCORE DATA: "+v.a.source().name+": "+v.a.score+", "+v.b.source().name+": "+v.b.score),v.a.score=v.b.score=null),{el:m,id:c,round:function(){return t},connectorCb:function(n){p=n},connect:function(n){var e,t,i=b.height()/4,r=m.height()/2;if(n&&null!==n){var a=n(b,this);if(null===a)return;e=a.shift,t=a.height}else c%2===0?0===this.winner().id?(e=i,t=r):1===this.winner().id?(e=3*i,t=r-2*i):(e=2*i,t=r-i):0===this.winner().id?(e=3*-i,t=-r+2*i):1===this.winner().id?(e=-i,t=-r):(e=2*-i,t=-r+i);b.append(w(t,e,b,f))},winner:function(){return s(v)},loser:function(){return o(v)},first:function(){return v.a},second:function(){return v.b},setAlignCb:function(n){g=n},render:function(){m.empty(),b.empty(),v.a.name=v.a.source().name,v.b.name=v.b.source().name,v.a.idx=v.a.source().idx,v.b.idx=v.b.source().idx;var n=!1;!v.a.name&&""!==v.a.name||!v.b.name&&""!==v.b.name||(n=!0),s(v).name?b.removeClass("np"):b.addClass("np"),b.append(h(t.id,v.a,n)),b.append(h(t.id,v.b,n)),m.appendTo(t.el),m.append(b),this.el.css("height",t.bracket.el.height()/t.size()+"px"),b.css("top",this.el.height()/2-b.height()/2+"px"),g&&g(b);var e=!1;"function"==typeof u&&(e=u(this)),e||this.connect(p)},results:function(){return[v.a.score,v.b.score]}}}var d,f="lr"===r.dir?"right":"left";if(!r)throw Error("Options not set");if(!r.el)throw Error("Invalid jQuery object as container");if(!r.init&&!r.save)throw Error("No bracket data or save callback given");if(void 0===r.userData&&(r.userData=null),!(!r.decorator||r.decorator.edit&&r.decorator.render))throw Error("Invalid decorator input");r.decorator||(r.decorator={edit:u,render:h});var m;r.init||(r.init={teams:[["",""]],results:[]}),m=r.init;var k,x,y,M=n('<div class="jQBracket '+r.dir+'"></div>').appendTo(r.el.empty()),T=m.results;T=i(T,4-t(T)),m.results=T;var E=T.length<=1&&!r.isDoubleElimination;r.skipSecondaryFinal&&E&&n.error("skipSecondaryFinal setting is viable only in double elimination mode"),r.save&&C(M,m,r);var R,A,D;E?A=n('<div class="bracket"></div>').appendTo(M):(R=n('<div class="finals"></div>').appendTo(M),A=n('<div class="bracket"></div>').appendTo(M),D=n('<div class="loserBracket"></div>').appendTo(M));var j=64*m.teams.length;A.css("height",j),E&&m.teams.length<=2&&!r.skipConsolationRound&&(j+=40,M.css("height",j)),D&&D.css("height",A.height()/2);var I;return I=E?Math.log(2*m.teams.length)/Math.log(2):2*(Math.log(2*m.teams.length)/Math.log(2)-1)+1,r.save?M.css("width",140*I+40):M.css("width",140*I+10),k=b(A,T&&T[0]?T[0]:null,c),E||(x=b(D,T&&T[1]?T[1]:null,c),y=b(R,T&&T[2]?T[2]:null,c)),v(k,m.teams,E,r.skipConsolationRound),E||(p(k,x,m.teams.length),g(y,k,x,r.skipSecondaryFinal,r.skipConsolationRound,M)),a(!1),{data:function(){return r.init}}},x={init:function(e){var t=this;e.el=this,e.save&&(e.onMatchClick||e.onMatchHover)&&n.error("Match callbacks may not be passed in edit mode (in conjunction with save callback)"),e.dir=e.dir||"lr",e.init.teams=e.init.teams&&0!=e.init.teams.length?e.init.teams:[["",""]],e.skipConsolationRound=e.skipConsolationRound||!1,e.isDoubleElimination=e.isDoubleElimination||!1,e.skipSecondaryFinal=e.skipSecondaryFinal||!1,e.disableTeamNameEdit=e.disableTeamNameEdit||!1,e.disableEditButtons=e.disableEditButtons||!1,"lr"!==e.dir&&"rl"!==e.dir&&n.error('Direction must be either: "lr" or "rl"');var i=k(e);return n(this).data("bracket",{target:t,obj:i}),i},data:function(){var e=n(this).data("bracket");return e.obj.data()}};n.fn.bracket=function(e){return x[e]?x[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void n.error("Method "+e+" does not exist on jQuery.bracket"):x.init.apply(this,arguments)}}(jQuery);